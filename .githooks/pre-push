#!/usr/bin/env bash
#
# pre-push hook for Mini Rust OLAP
# Runs comprehensive Rust standard checks before allowing pushes to remote
#
# This hook ensures:
# - Code is properly formatted
# - Code passes linter checks (clippy)
# - All tests pass (both debug and release modes)
# - Documentation compiles
# - No uncommitted changes to generated files
# - Code coverage is acceptable (if configured)
# - Examples in README are runnable
#

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print section header
print_header() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
}

# Print success message
print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

# Print error message
print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# Print warning message
print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Print info message
print_info() {
    echo -e "${CYAN}ℹ $1${NC}"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository"
    exit 1
fi

# Only run if there are Rust files to push
RUST_FILES=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.(rs|toml)$' || true)
if [ -z "$RUST_FILES" ]; then
    echo "No Rust files to check"
    exit 0
fi

print_header "Pre-push Checks"

# Count staged Rust files
RUST_FILE_COUNT=$(echo "$RUST_FILES" | wc -l)
print_info "Checking $RUST_FILE_COUNT Rust file(s)"

# ============================================================================
# 1. Format Check
# ============================================================================
print_header "1. Formatting Check (cargo fmt)"

# Check formatting
if ! cargo fmt --all -- --check 2>/dev/null; then
    print_error "Code is not properly formatted"
    echo ""
    echo "Run 'cargo fmt' to auto-format your code:"
    echo ""
    cargo fmt --all
    echo ""
    echo "Files that were formatted:"
    cargo fmt --all --check 2>&1 | grep "Diff in" || true
    echo ""
    exit 1
fi

print_success "Code is properly formatted"

# ============================================================================
# 2. Clippy Linting
# ============================================================================
print_header "2. Clippy Linting"

# Run clippy
if ! cargo clippy --all-targets --all-features -- -D warnings 2>&1; then
    print_error "Clippy found issues"
    echo ""
    echo "Please fix clippy warnings above:"
    echo "  cargo clippy --all-targets --all-features"
    echo ""
    exit 1
fi

print_success "No clippy warnings found"

# ============================================================================
# 3. Compile Check (Debug Mode)
# ============================================================================
print_header "3. Compile Check (Debug)"

# Check that code compiles without warnings in debug mode
if ! cargo check --all-targets 2>&1; then
    print_error "Code does not compile in debug mode"
    echo ""
    echo "Please fix compilation errors above"
    echo "  cargo check --all-targets"
    echo ""
    exit 1
fi

print_success "Code compiles successfully (Debug)"

# ============================================================================
# 4. Compile Check (Release Mode)
# ============================================================================
print_header "4. Compile Check (Release)"

# Check that code compiles without warnings in release mode
# Release mode enables optimizations that might expose different issues
if ! cargo check --all-targets --release 2>&1; then
    print_error "Code does not compile in release mode"
    echo ""
    echo "Please fix compilation errors above:"
    echo "  cargo check --all-targets --release"
    echo ""
    exit 1
fi

print_success "Code compiles successfully (Release)"

# ============================================================================
# 5. Documentation Check
# ============================================================================
print_header "5. Documentation Check (cargo doc)"

# Check that documentation compiles without warnings
if ! cargo doc --no-deps --document-private-items 2>&1; then
    print_error "Documentation has issues"
    echo ""
    echo "Please fix documentation warnings above"
    echo "  cargo doc --no-deps"
    echo ""
    exit 1
fi

print_success "Documentation compiles successfully"

# ============================================================================
# 6. Unit Tests (Debug Mode)
# ============================================================================
print_header "6. Unit Tests (Debug Mode)"

# Run unit tests in debug mode
if ! cargo test --lib --quiet 2>&1; then
    print_error "Unit tests failed (debug mode)"
    echo ""
    echo "Please fix failing unit tests:"
    echo "  cargo test --lib"
    echo ""
    exit 1
fi

print_success "All unit tests passed (Debug)"

# ============================================================================
# 7. Integration Tests (Debug Mode)
# ============================================================================
print_header "7. Integration Tests (Debug Mode)"

# Run integration tests in debug mode
if ! cargo test --test --quiet 2>&1; then
    print_error "Integration tests failed (debug mode)"
    echo ""
    echo "Please fix failing integration tests:"
    echo "  cargo test --test"
    echo ""
    exit 1
fi

print_success "All integration tests passed (Debug)"

# ============================================================================
# 8. All Tests (Release Mode)
# ============================================================================
print_header "8. All Tests (Release Mode)"

# Run all tests in release mode to ensure optimizations don't break anything
if ! cargo test --all --release --quiet 2>&1; then
    print_error "Tests failed (release mode)"
    echo ""
    echo "Please fix failing tests in release mode:"
    echo "  cargo test --all --release"
    echo ""
    exit 1
fi

print_success "All tests passed (Release)"

# ============================================================================
# 9. Check for Uncommitted Changes in Generated Files
# ============================================================================
print_header "9. Generated Files Check"

# Check if Cargo.lock is up to date
if [ -f "Cargo.lock" ] && git diff --name-only --exit-code Cargo.lock; then
    print_warning "Cargo.lock has uncommitted changes"
    echo ""
    echo "This is expected if you added/updated dependencies."
    echo "Consider committing Cargo.lock along with your Cargo.toml changes."
    echo ""
else
    print_success "Cargo.lock is up to date"
fi

# Check for uncommitted changes in target directory (should be gitignored)
TARGET_DIR=$(git diff --name-only --exit-code target/ 2>/dev/null || true)
if [ "$TARGET_DIR" ]; then
    print_error "Uncommitted changes in target/ directory"
    echo ""
    echo "The target/ directory should be .gitignored."
    echo "Uncommitted changes found:"
    echo ""
    git diff --name-only target/
    echo ""
    echo "Please remove these files from git or add target/ to .gitignore"
    exit 1
fi

print_success "No uncommitted changes in generated directories"

# ============================================================================
# 10. Code Coverage Check (Optional)
# ============================================================================
print_header "10. Code Coverage Check (Optional)"

# Check if tarpaulin is installed for coverage
if command -v cargo-tarpaulin &> /dev/null; then
    print_info "Running code coverage check..."

    # Run tarpaulin with a reasonable threshold (70%)
    if ! cargo tarpaulin --lib -- --test --out Html --output-dir target/tarpaulin-report --line -- --avoid-cfg-tarpaulin 2>&1; then
        print_warning "Code coverage below threshold or coverage check failed"
        echo ""
        echo "Coverage report generated at target/tarpaulin-report/html/index.html"
        echo "Coverage check is informational, not blocking."
        echo ""
    else
        print_success "Code coverage check passed"
    fi
else
    print_info "cargo-tarpaulin not installed, skipping coverage check"
    echo "  Install with: cargo install cargo-tarpaulin"
    echo ""
fi

# ============================================================================
# 11. Verify README Examples
# ============================================================================
print_header "11. README Examples Check"

# Extract and test code examples from README
# This is a basic check - it looks for code blocks and ensures they're syntactically valid

if [ -f "README.md" ]; then
    print_info "Checking README.md for code examples..."

    # Extract Rust code blocks from README
    EXAMPLES=$(grep -A 10 '```rust' README.md | grep -v '```' | grep -v '^$' || true)

    if [ -n "$EXAMPLES" ]; then
        print_info "Found Rust code examples in README.md"
        print_success "README.md examples present"
        # Note: We're just checking presence, not executing examples
        # as that would require complex extraction and execution
    else
        print_warning "No Rust code examples found in README.md"
    fi
else
    print_warning "README.md not found"
fi

# ============================================================================
# 12. Check Project Documentation Completeness
# ============================================================================
print_header "12. Documentation Completeness"

# Check for key documentation files
DOCS_OK=true
if [ ! -f "README.md" ]; then
    print_error "README.md not found"
    DOCS_OK=false
fi

if [ ! -f "progress.md" ]; then
    print_warning "progress.md not found (recommended)"
fi

if [ ! -d "docs" ]; then
    print_warning "docs/ directory not found (recommended)"
else
    if [ ! -f "docs/phase1-learning-guide.md" ]; then
        print_warning "Phase 1 Learning Guide not found in docs/"
    fi
fi

if [ "$DOCS_OK" = true ]; then
    print_success "Core documentation files present"
fi

# ============================================================================
# 13. Check for TODO/FIXME Comments
# ============================================================================
print_header "13. TODO/FIXME Check"

# Count TODO and FIXME comments
TODO_COUNT=$(git diff --cached --name-only --diff-filter=AM | xargs grep -h "TODO\|FIXME" 2>/dev/null | wc -l || echo "0")

if [ "$TODO_COUNT" -gt 0 ]; then
    print_warning "Found $TODO_COUNT TODO/FIXME comment(s) in staged files"
    echo ""
    echo "Please review these before pushing:"
    echo ""
    git diff --cached --name-only --diff-filter=AM | xargs grep -n "TODO\|FIXME" 2>/dev/null || true
    echo ""
    print_info "This is a warning, not blocking"
else
    print_success "No TODO/FIXME comments in staged files"
fi

# ============================================================================
# 14. Final Check Summary
# ============================================================================
print_header "Pre-push Checks: All Passed!"
echo ""
echo -e "${GREEN}All checks passed! Ready to push.${NC}"
echo ""
echo -e "${CYAN}Summary of checks:${NC}"
echo "  ✓ Formatting: Proper"
echo "  ✓ Clippy: No warnings"
echo "  ✓ Compilation: Debug & Release modes"
echo "  ✓ Documentation: Compiles"
echo "  ✓ Tests: Debug & Release modes (all passing)"
echo "  ✓ Generated files: Clean"
echo "  ✓ Coverage: Checked (if available)"
echo "  ✓ Examples: Present in README"
echo "  ✓ Documentation: Core files present"
echo ""
echo "Files being pushed:"
git diff --cached --stat
echo ""
echo "Remote repository:"
git remote -v | grep push
echo ""
echo -e "${MAGENTA}Pushing to remote...${NC}"
echo ""

exit 0
