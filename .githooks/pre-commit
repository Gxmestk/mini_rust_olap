#!/usr/bin/env bash
#
# pre-commit hook for Mini Rust OLAP
# Runs comprehensive Rust standard checks before allowing commits
#
# This hook ensures:
# - Code is properly formatted
# - Code passes linter checks (clippy)
# - All tests pass
# - Documentation compiles

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print section header
print_header() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
}

# Print success message
print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

# Print error message
print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# Print warning message
print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository"
    exit 1
fi

# Only run if there are Rust files to commit
RUST_FILES=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.(rs|toml)$' || true)
if [ -z "$RUST_FILES" ]; then
    echo "No Rust files to check"
    exit 0
fi

print_header "Pre-commit Checks"

# ============================================================================
# 1. Format Check
# ============================================================================
print_header "1. Formatting Check (cargo fmt)"

# Check formatting
if ! cargo fmt --all -- --check 2>/dev/null; then
    print_error "Code is not properly formatted"
    echo ""
    echo "Run 'cargo fmt' to auto-format your code:"
    echo ""
    cargo fmt --all
    echo ""
    echo "Files that were formatted:"
    cargo fmt --all --check 2>&1 | grep "Diff in" || true
    echo ""
    exit 1
fi

print_success "Code is properly formatted"

# ============================================================================
# 2. Clippy Linting
# ============================================================================
print_header "2. Clippy Linting"

# Run clippy
if ! cargo clippy --all-targets --all-features -- -D warnings 2>&1; then
    print_error "Clippy found issues"
    echo ""
    echo "Please fix the clippy warnings above:"
    echo "  cargo clippy --all-targets --all-features"
    echo ""
    exit 1
fi

print_success "No clippy warnings found"

# ============================================================================
# 3. Compile Check
# ============================================================================
print_header "3. Compile Check (cargo check)"

# Check that code compiles without warnings
if ! cargo check --all-targets 2>&1; then
    print_error "Code does not compile"
    echo ""
    echo "Please fix compilation errors above"
    exit 1
fi

print_success "Code compiles successfully"

# ============================================================================
# 4. Documentation Check
# ============================================================================
print_header "4. Documentation Check (cargo doc)"

# Check that documentation compiles without warnings
if ! cargo doc --no-deps --document-private-items 2>&1; then
    print_error "Documentation has issues"
    echo ""
    echo "Please fix documentation warnings above"
    exit 1
fi

print_success "Documentation compiles successfully"

# ============================================================================
# 5. Unit Tests
# ============================================================================
print_header "5. Unit Tests (cargo test --lib)"

# Run unit tests
if ! cargo test --lib --quiet 2>&1; then
    print_error "Unit tests failed"
    echo ""
    echo "Please fix failing unit tests:"
    echo "  cargo test --lib"
    echo ""
    exit 1
fi

print_success "All unit tests passed"

# ============================================================================
# 6. Integration Tests
# ============================================================================
print_header "6. Integration Tests (cargo test --test)"

# Run integration tests
if ! cargo test --test --quiet 2>&1; then
    print_error "Integration tests failed"
    echo ""
    echo "Please fix failing integration tests:"
    echo "  cargo test --test"
    echo ""
    exit 1
fi

print_success "All integration tests passed"

# ============================================================================
# Summary
# ============================================================================
print_header "Pre-commit Checks: All Passed!"
echo ""
echo -e "${GREEN}All checks passed! Ready to commit.${NC}"
echo ""
echo "Changes staged for commit:"
git diff --cached --stat
echo ""
exit 0
